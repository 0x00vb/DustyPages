<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- iOS 9 Safari detection and redirection -->
    <script>
        (function() {
            // More reliable iOS detection
            var isIOS = /iPad|iPhone|iPod/.test(navigator.platform) || 
                        (navigator.userAgent.includes("Mac") && "ontouchend" in document);
            
            if (isIOS) {
                // More reliable version detection
                var match = navigator.userAgent.match(/OS (\d+)[._]/);
                if (match && match[1]) {
                    var version = parseInt(match[1], 10);
                    console.log("iOS version detected:", version);
                    
                    // If iOS 9 or below, redirect to the simplified page
                    if (version <= 9) {
                        console.log("Redirecting to iOS 9 fallback page");
                        window.location.href = 'ios9-fallback.html';
                    } else {
                        console.log("Modern iOS detected:", version);
                        // Mark as modern iOS
                        window.isModerniOS = true;
                    }
                } else {
                    console.log("iOS device detected but couldn't determine version");
                }
            } else {
                console.log("Not an iOS device");
            }
        })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="RustyPages">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#f2f2f2">
    <meta name="description" content="Lightweight EPUB/PDF Reader for older devices">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="public/DustyPagesLogo.png">
    <link rel="icon" href="public/DustyPagesLogo.ico" type="image/x-icon">
    <title>RustyPages</title>
    <style>
        /* Critical styles that must load first */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #fff;
        }
        .app-header {
            background: #f2f2f2;
            height: 60px;
            display: block;
            position: relative;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }
        .app-header h1 {
            margin: 0;
            line-height: 60px;
            font-size: 20px;
            font-weight: 500;
        }
        .book-shelf {
            position: absolute;
            top: 60px;
            bottom: 0;
            width: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .empty-message {
            padding: 40px 20px;
            text-align: center;
        }
        button {
            background: #007aff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            margin-top: 15px;
            cursor: pointer;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #emergency-load-error {
            display: none;
            padding: 20px;
            text-align: center;
            color: #333;
        }
        #emergency-import {
            display: none;
        }
        /* Basic styling for book items in emergency mode */
        .book-item {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .book-item:hover {
            background: #f5f5f5; /* Highlight on hover */
        }
        .book-info {
            flex: 1;
            padding-right: 10px;
        }
        .book-item h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
        }
        .book-item p {
            margin: 0;
            color: #666;
        }
        .delete-book-btn {
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 0;
            font-size: 14px;
            cursor: pointer;
        }
        /* Mobile optimizations */
        @media (max-width: 480px) {
            .book-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .book-info {
                width: 100%;
                margin-bottom: 10px;
            }
            .delete-book-btn {
                align-self: flex-end;
            }
            #settings-panel {
                top: 5%;
                left: 5%;
                width: 90%;
                max-height: 90%;
            }
            .theme-options, .font-family-control {
                flex-direction: column;
            }
            .font-btn {
                flex: 1 0 100%;
            }
            .reader-controls {
                padding: 0 5px;
            }
        }
        /* View switching */
        .view {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        .view.active {
            display: block;
        }
        /* Reader view */
        #reader-container {
            position: absolute;
            top: 60px;
            bottom: 60px; /* Space for controls */
            width: 100%;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            background: #fff;
        }
        #reader-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: #f2f2f2;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            box-sizing: border-box;
            border-top: 1px solid #ddd;
        }
        /* Back button */
        #back-btn {
            position: absolute;
            left: 10px;
            top: 10px;
            width: 40px;
            height: 40px;
            background: #f8f8f8;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        #back-btn:before {
            content: "←";
        }
        /* Settings button */
        #settings-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            width: 40px;
            height: 40px;
            background: #f8f8f8;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        #settings-btn:before {
            content: "⚙️";
        }
        /* Settings panel */
        #settings-panel {
            display: none;
            position: fixed;
            top: 10%;
            left: 10%;
            width: 80%;
            max-height: 80%;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            padding: 20px;
            z-index: 1000;
            overflow-y: auto;
        }
        /* Setting groups */
        .setting-group {
            margin-bottom: 20px;
        }
        .setting-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        /* Theme buttons */
        .theme-options {
            display: flex;
            gap: 10px;
        }
        .theme-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 6px;
        }
        .theme-btn[data-theme="light"] {
            background: #fff;
            color: #333;
            border: 1px solid #ddd;
        }
        .theme-btn[data-theme="sepia"] {
            background: #f8f1e3;
            color: #5b4636;
            border: 1px solid #e8d1b3;
        }
        .theme-btn[data-theme="dark"] {
            background: #222;
            color: #ddd;
            border: 1px solid #444;
        }
        /* Font controls */
        .font-size-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #font-size-value {
            flex: 1;
            text-align: center;
        }
        /* Font buttons */
        .font-family-control {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .font-btn {
            flex: 1 0 45%;
            margin-bottom: 5px;
            text-align: center;
        }
        /* Slider controls */
        .slider-control {
            padding: 10px 0;
        }
        .slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slider {
            flex: 1;
            width: 100%;
        }
        /* Active states */
        .theme-btn.active, .font-btn.active {
            border: 2px solid #007aff;
            font-weight: bold;
        }
        /* Page styles */
        .book-page {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .book-page h2 {
            margin-top: 0;
            text-align: center;
        }
        .book-page p {
            margin-bottom: 1em;
        }
    </style>
    <link rel="stylesheet" href="css/styles.css">
    <script>
        // Show UI if scripts fail completely (iPad iOS 9 Safari)
        window.onerror = function(msg, url, line) {
            console.error('Error:', msg, 'at', url, ':', line);
            
            // Skip activating emergency mode for modern iOS
            if (window.isModerniOS) {
                console.log("Error occurred but not activating emergency mode on modern iOS");
                return false;
            }
            
            // Show emergency content after 3 seconds if normal loading fails
            setTimeout(function() {
                try {
                    var main = document.getElementById('main-content');
                    var emergencyError = document.getElementById('emergency-load-error');
                    var emergencyImport = document.getElementById('emergency-import');
                    var loadingScreen = document.getElementById('initial-loader');
                    
                    if (emergencyError && loadingScreen) {
                        if (loadingScreen.style.display !== 'none') {
                            // Still showing loader after 3 seconds, show emergency UI
                            loadingScreen.style.display = 'none';
                            emergencyError.style.display = 'block';
                            if (emergencyImport) emergencyImport.style.display = 'block';
                            
                            // Hide any empty message
                            var emptyMsg = document.getElementById('empty-library');
                            if (emptyMsg) emptyMsg.style.display = 'none';
                            
                            // Make sure main content is visible
                            if (main) main.style.display = 'block';
                        }
                    }
                } catch(e) {
                    console.error('Emergency UI error:', e);
                }
            }, 3000);
            
            // Don't prevent other error handlers
            return false;
        };
        
        // Safari iOS 9 compatibility layer - runs immediately
        (function() {
            // Force rendering before scripts run
            document.documentElement.style.display = 'none';
            setTimeout(function() {
                document.documentElement.style.display = '';
            }, 10);
            
            // Detect iOS Safari
            var isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
            var isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
            
            if (isIOS && isSafari) {
                // Add iOS Safari class
                document.documentElement.className += ' ios-safari';
                
                // Add iOS version class 
                var match = navigator.userAgent.match(/OS (\d+)_/);
                if (match && match[1]) {
                    var version = parseInt(match[1], 10);
                    document.documentElement.className += ' ios-' + version;
                    
                    // For iOS 9, show main content right away
                    if (version <= 9) {
                        document.addEventListener('DOMContentLoaded', function() {
                            var main = document.getElementById('main-content');
                            if (main) main.style.display = 'block';
                        });
                    }
                }
                
                // Add standalone mode detection
                if (window.navigator.standalone) {
                    document.documentElement.className += ' ios-standalone';
                }
            }
            
            // For iOS 9, ensure localStorage works (even in private browsing)
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
            } catch (e) {
                // Create memory-based fallback
                var memStorage = {};
                window.localStorage = {
                    getItem: function(key) { return memStorage[key] || null; },
                    setItem: function(key, value) { memStorage[key] = String(value); },
                    removeItem: function(key) { delete memStorage[key]; }
                };
            }
        })();
        
        // Define global objects early to prevent errors
        window.RustyPages = {
            ready: false,
            modules: {
                Reader: null,
                Library: null,
                Storage: null
            },
            fallbackMode: false,
            init: function() {
                console.log('RustyPages initialized in ' + 
                    (this.fallbackMode ? 'fallback' : 'normal') + ' mode');
                
                if (this.fallbackMode) {
                    // Show a basic interface in fallback mode
                    this.showFallbackUI();
                }
                
                // Hide the loader
                var loader = document.getElementById('initial-loader');
                if (loader) loader.style.display = 'none';
                
                this.ready = true;
            },
            showFallbackUI: function() {
                var bookList = document.getElementById('book-list');
                if (bookList) {
                    bookList.innerHTML = '<div style="padding: 20px; text-align: center;">' +
                        '<p>Welcome to RustyPages (Basic Mode)</p>' +
                        '<p>Click Import to add books to your library</p>' +
                        '</div>';
                }
                
                var importBtn = document.getElementById('import-btn');
                var fileInput = document.getElementById('file-input');
                
                if (importBtn && fileInput) {
                    importBtn.onclick = function() {
                        fileInput.click();
                    };
                    
                    fileInput.onchange = function(e) {
                        if (e.target.files.length > 0) {
                            // Process and save the files first
                            var files = e.target.files;
                            var savedFiles = [];
                            
                            for (var i = 0; i < files.length; i++) {
                                var file = files[i];
                                var fileName = file.name;
                                var fileExt = fileName.split('.').pop().toLowerCase();
                                
                                // Create book object
                                var book = {
                                    id: 'book_' + Date.now() + '_' + i,
                                    title: fileName.replace(/\.[^/.]+$/, ""), // Remove extension
                                    format: fileExt === 'pdf' ? 'PDF' : 'EPUB',
                                    dateAdded: new Date().toISOString(),
                                    fileName: fileName
                                };
                                
                                savedFiles.push(book);
                            }
                            
                            // Save to localStorage - with more robust error handling for Safari
                            try {
                                console.log("Starting to save books to localStorage");
                                
                                // Test if localStorage is writable
                                try {
                                    localStorage.setItem('test_storage', 'test');
                                    localStorage.removeItem('test_storage');
                                } catch(storageErr) {
                                    console.error("localStorage test failed:", storageErr);
                                    alert("Storage error: Your browser may be in private browsing mode or has localStorage disabled.");
                                    return;
                                }
                                
                                // Get existing books
                                var existingBooks = [];
                                try {
                                    var storedBooks = localStorage.getItem('rustyPages_books');
                                    console.log("Existing stored books:", storedBooks);
                                    if (storedBooks) {
                                        existingBooks = JSON.parse(storedBooks);
                                    }
                                } catch(e) {
                                    console.error('Error loading books:', e);
                                    existingBooks = [];
                                }
                                
                                // Add new books
                                if (!Array.isArray(existingBooks)) {
                                    existingBooks = [];
                                }
                                
                                existingBooks = existingBooks.concat(savedFiles);
                                
                                // Save back to localStorage
                                var booksToStore = JSON.stringify(existingBooks);
                                console.log("Saving books to localStorage:", booksToStore.substring(0, 100) + "...");
                                localStorage.setItem('rustyPages_books', booksToStore);
                                
                                // Verify the books were saved
                                var verifyTest = localStorage.getItem('rustyPages_books');
                                if (!verifyTest) {
                                    throw new Error("Failed to verify books were saved to localStorage");
                                }
                                
                                console.log("Books saved successfully");
                                alert('Import successful! ' + files.length + ' file(s) added to library.');
                                
                                // Now manually render the books without refreshing
                                loadSavedBooks();
                                
                                // Hide any emergency messages
                                var emergencyError = document.getElementById('emergency-load-error');
                                var emergencyImport = document.getElementById('emergency-import');
                                if (emergencyError) emergencyError.style.display = 'none';
                                if (emergencyImport) emergencyImport.style.display = 'none';
                                
                                // Show book list and hide empty message
                                var emptyLibrary = document.getElementById('empty-library');
                                if (emptyLibrary) emptyLibrary.style.display = 'none';
                            } catch(e) {
                                console.error('Error saving books:', e);
                                alert('Error saving books: ' + e.message + '. Please try again.');
                            }
                        }
                    };
                }
            },
            activateFallbackMode: function() {
                console.log('Activating fallback mode for compatibility');
                this.fallbackMode = true;
                this.init();
            }
        };
    </script>
</head>
<body>
    <div id="main-content" style="display:block;">
        <div id="app">
            <div id="library-view" class="view active">
                <header class="app-header">
                    <h1>RustyPages Library</h1>
                    <button id="import-btn" class="icon-btn" aria-label="Import books" style="position:absolute; right:10px; top:10px; background:#f8f8f8; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;">+</button>
                </header>
                
                <div class="book-shelf">
                    <div id="emergency-load-error">
                        <h2>Basic Mode Active</h2>
                        <p>RustyPages is running in basic compatibility mode for your device.</p>
                        <p>Use the import button in the top right to add books.</p>
                    </div>
                    <div id="book-list"></div>
                    <div id="empty-library" class="empty-message">
                        <p>Your library is empty</p>
                        <button id="empty-import-btn">Import Books</button>
                    </div>
                    <div id="emergency-import" class="empty-message">
                        <button id="emergency-import-btn">Import Books</button>
                    </div>
                </div>
                
                <input type="file" id="file-input" accept=".epub,.pdf" multiple style="display: none;">
            </div>

            <div id="reader-view" class="view">
                <header class="app-header">
                    <button id="back-btn" class="icon-btn" aria-label="Back to library"></button>
                    <h2 id="book-title">Book Title</h2>
                    <button id="settings-btn" class="icon-btn" aria-label="Reading settings"></button>
                </header>
                
                <div id="reader-container"></div>
                
                <div id="reader-controls">
                    <button id="prev-btn">Previous</button>
                    <span id="page-info">Page <span id="current-page">0</span> of <span id="total-pages">0</span></span>
                    <button id="next-btn">Next</button>
                </div>
            </div>
        </div>

        <div id="settings-panel" class="panel">
            <h3>Reading Settings</h3>
            
            <div class="setting-group">
                <label>Theme</label>
                <div class="theme-options">
                    <button class="theme-btn" data-theme="light">Light</button>
                    <button class="theme-btn" data-theme="sepia">Sepia</button>
                    <button class="theme-btn" data-theme="dark">Dark</button>
                </div>
            </div>
            
            <div class="setting-group">
                <label>Font Size</label>
                <div class="font-size-control">
                    <button id="font-decrease">A-</button>
                    <span id="font-size-value">100%</span>
                    <button id="font-increase">A+</button>
                </div>
            </div>
            
            <div class="setting-group">
                <label>Font Family</label>
                <div class="font-family-control">
                    <button class="font-btn" data-font="serif">Serif</button>
                    <button class="font-btn" data-font="sans-serif">Sans-serif</button>
                    <button class="font-btn" data-font="merriweather">Merriweather</button>
                    <button class="font-btn" data-font="open-dyslexic">OpenDyslexic</button>
                    <button class="font-btn" data-font="literata">Literata</button>
                </div>
            </div>
            
            <div class="setting-group">
                <label>Letter Spacing</label>
                <div class="slider-control">
                    <div class="slider-row">
                        <input type="range" id="letter-spacing" class="slider" min="0" max="10" value="0">
                        <div class="slider-value" id="letter-spacing-value">0px</div>
                    </div>
                </div>
            </div>
            
            <div class="setting-group">
                <label>Line Height</label>
                <div class="slider-control">
                    <div class="slider-row">
                        <input type="range" id="line-height" class="slider" min="100" max="200" value="160">
                        <div class="slider-value" id="line-height-value">1.6</div>
                    </div>
                </div>
            </div>
            
            <div class="setting-group" id="pdf-settings">
                <label>PDF Night Mode</label>
                <div class="toggle-switch">
                    <input type="checkbox" id="pdf-night-mode">
                    <label for="pdf-night-mode">Enable night mode for PDFs</label>
                </div>
            </div>
            
            <button id="close-settings">Apply & Close</button>
        </div>
    </div>

    <!-- Initial loading spinner for iOS Safari -->
    <div id="initial-loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f8f8f8; display:flex; align-items:center; justify-content:center; z-index:10000; font-size:20px; color:#333;">
        Loading RustyPages...
    </div>

    <!-- Global function to load books - accessible to all scripts -->
    <script>
        function loadSavedBooks() {
            console.log("Loading saved books");
            var bookList = document.getElementById('book-list');
            var emptyLibrary = document.getElementById('empty-library');
            
            if (!bookList) {
                console.error("Book list element not found");
                return;
            }
            
            try {
                var books = [];
                var storedBooks = localStorage.getItem('rustyPages_books');
                console.log("Retrieved books from storage:", storedBooks ? storedBooks.substring(0, 100) + "..." : "none");
                
                if (storedBooks) {
                    books = JSON.parse(storedBooks);
                }
                
                if (Array.isArray(books) && books.length > 0) {
                    // We have books to display
                    console.log("Found " + books.length + " books to display");
                    var html = '';
                    
                    for (var i = 0; i < books.length; i++) {
                        var book = books[i];
                        html += '<div class="book-item" data-book-id="' + book.id + '" data-book-format="' + book.format + '">' +
                            '<div class="book-info">' +
                            '<h3>' + (book.title || 'Untitled Book') + '</h3>' +
                            '<p>Format: ' + (book.format || 'Unknown') + '</p>' +
                            '</div>' +
                            '<button class="delete-book-btn" data-book-id="' + book.id + '">Delete</button>' +
                            '</div>';
                    }
                    
                    bookList.innerHTML = html;
                    
                    // Add click handlers to book items
                    var bookItems = bookList.getElementsByClassName('book-item');
                    for (var j = 0; j < bookItems.length; j++) {
                        // Use delegate pattern to handle clicks properly
                        bookItems[j].addEventListener('click', function(e) {
                            // Ignore if delete button was clicked
                            if (e.target.classList.contains('delete-book-btn') || 
                                e.target.closest('.delete-book-btn')) {
                                return;
                            }
                            
                            var bookId = this.getAttribute('data-book-id');
                            var bookFormat = this.getAttribute('data-book-format');
                            openBook(bookId, bookFormat);
                        });
                    }
                    
                    // Add delete button handlers
                    var deleteButtons = bookList.getElementsByClassName('delete-book-btn');
                    for (var k = 0; k < deleteButtons.length; k++) {
                        deleteButtons[k].addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            var bookId = this.getAttribute('data-book-id');
                            deleteBook(bookId);
                        });
                    }
                    
                    // Hide empty library message
                    if (emptyLibrary) {
                        emptyLibrary.style.display = 'none';
                    }
                    
                    // Hide emergency UI
                    var emergencyError = document.getElementById('emergency-load-error');
                    var emergencyImport = document.getElementById('emergency-import');
                    if (emergencyError) emergencyError.style.display = 'none';
                    if (emergencyImport) emergencyImport.style.display = 'none';
                    
                    return true;
                } else {
                    // No books, show empty message
                    console.log("No books found in storage");
                    if (emptyLibrary) {
                        emptyLibrary.style.display = 'block';
                    }
                    return false;
                }
            } catch(e) {
                console.error('Error loading books:', e);
                // Show empty state on error
                if (emptyLibrary) {
                    emptyLibrary.style.display = 'block';
                }
                return false;
            }
        }
        
        // Function to open a book
        function openBook(bookId, bookFormat) {
            console.log("Opening book:", bookId, "Format:", bookFormat);
            
            try {
                // Get the book data from localStorage
                var storedBooks = localStorage.getItem('rustyPages_books');
                if (!storedBooks) {
                    alert("Error: No books found in storage");
                    return;
                }
                
                var books = JSON.parse(storedBooks);
                var selectedBook = null;
                
                // Find the book by ID
                for (var i = 0; i < books.length; i++) {
                    if (books[i].id === bookId) {
                        selectedBook = books[i];
                        break;
                    }
                }
                
                if (!selectedBook) {
                    alert("Error: Book not found");
                    return;
                }
                
                // Show book title in the reader view
                var bookTitleElement = document.getElementById('book-title');
                if (bookTitleElement) {
                    bookTitleElement.textContent = selectedBook.title || 'Untitled Book';
                }
                
                // Switch to reader view
                var libraryView = document.getElementById('library-view');
                var readerView = document.getElementById('reader-view');
                
                if (libraryView && readerView) {
                    libraryView.classList.remove('active');
                    readerView.classList.add('active');
                }
                
                // Set up back button
                var backButton = document.getElementById('back-btn');
                if (backButton) {
                    backButton.onclick = function() {
                        // Switch back to library view
                        readerView.classList.remove('active');
                        libraryView.classList.add('active');
                    };
                }
                
                // Create pages from book content
                var pages = createPagesFromBook(selectedBook);
                
                // Initialize reader state
                window.readerState = {
                    currentPage: 1,
                    totalPages: pages.length,
                    pages: pages,
                    book: selectedBook,
                    theme: 'light',
                    fontSize: 100,
                    fontFamily: 'sans-serif',
                    letterSpacing: 0,
                    lineHeight: 160
                };
                
                // Set up page navigation
                var prevBtn = document.getElementById('prev-btn');
                var nextBtn = document.getElementById('next-btn');
                var currentPageEl = document.getElementById('current-page');
                var totalPagesEl = document.getElementById('total-pages');
                
                // Update page display
                function updatePageDisplay() {
                    if (currentPageEl) currentPageEl.textContent = window.readerState.currentPage;
                    if (totalPagesEl) totalPagesEl.textContent = window.readerState.totalPages;
                    
                    // Display current page
                    var readerContainer = document.getElementById('reader-container');
                    if (readerContainer) {
                        readerContainer.innerHTML = window.readerState.pages[window.readerState.currentPage - 1];
                        
                        // Apply current styles
                        applyReaderStyles();
                    }
                    
                    // Enable/disable buttons
                    if (prevBtn) prevBtn.disabled = window.readerState.currentPage <= 1;
                    if (nextBtn) nextBtn.disabled = window.readerState.currentPage >= window.readerState.totalPages;
                }
                
                // Set up page navigation
                if (prevBtn) {
                    prevBtn.onclick = function() {
                        if (window.readerState.currentPage > 1) {
                            window.readerState.currentPage--;
                            updatePageDisplay();
                        }
                    };
                }
                
                if (nextBtn) {
                    nextBtn.onclick = function() {
                        if (window.readerState.currentPage < window.readerState.totalPages) {
                            window.readerState.currentPage++;
                            updatePageDisplay();
                        }
                    };
                }
                
                // Set up settings button
                var settingsBtn = document.getElementById('settings-btn');
                var settingsPanel = document.getElementById('settings-panel');
                var closeSettingsBtn = document.getElementById('close-settings');
                
                if (settingsBtn && settingsPanel) {
                    settingsBtn.onclick = function() {
                        settingsPanel.style.display = 'block';
                    };
                }
                
                if (closeSettingsBtn) {
                    closeSettingsBtn.onclick = function() {
                        settingsPanel.style.display = 'none';
                    };
                }
                
                // Set up theme options
                var themeButtons = document.querySelectorAll('.theme-btn');
                for (var t = 0; t < themeButtons.length; t++) {
                    themeButtons[t].addEventListener('click', function() {
                        var theme = this.getAttribute('data-theme');
                        window.readerState.theme = theme;
                        applyReaderStyles();
                        
                        // Update active button
                        for (var b = 0; b < themeButtons.length; b++) {
                            themeButtons[b].classList.remove('active');
                        }
                        this.classList.add('active');
                    });
                }
                
                // Set up font size controls
                var fontDecreaseBtn = document.getElementById('font-decrease');
                var fontIncreaseBtn = document.getElementById('font-increase');
                var fontSizeValue = document.getElementById('font-size-value');
                
                if (fontDecreaseBtn) {
                    fontDecreaseBtn.onclick = function() {
                        if (window.readerState.fontSize > 80) {
                            window.readerState.fontSize -= 10;
                            updateFontSizeDisplay();
                            applyReaderStyles();
                        }
                    };
                }
                
                if (fontIncreaseBtn) {
                    fontIncreaseBtn.onclick = function() {
                        if (window.readerState.fontSize < 200) {
                            window.readerState.fontSize += 10;
                            updateFontSizeDisplay();
                            applyReaderStyles();
                        }
                    };
                }
                
                function updateFontSizeDisplay() {
                    if (fontSizeValue) {
                        fontSizeValue.textContent = window.readerState.fontSize + '%';
                    }
                }
                
                // Set up font family options
                var fontButtons = document.querySelectorAll('.font-btn');
                for (var f = 0; f < fontButtons.length; f++) {
                    fontButtons[f].addEventListener('click', function() {
                        var font = this.getAttribute('data-font');
                        window.readerState.fontFamily = font;
                        applyReaderStyles();
                        
                        // Update active button
                        for (var fb = 0; fb < fontButtons.length; fb++) {
                            fontButtons[fb].classList.remove('active');
                        }
                        this.classList.add('active');
                    });
                }
                
                // Set up letter spacing slider
                var letterSpacingSlider = document.getElementById('letter-spacing');
                var letterSpacingValue = document.getElementById('letter-spacing-value');
                
                if (letterSpacingSlider) {
                    letterSpacingSlider.addEventListener('input', function() {
                        window.readerState.letterSpacing = parseInt(this.value);
                        updateLetterSpacingDisplay();
                        applyReaderStyles();
                    });
                }
                
                function updateLetterSpacingDisplay() {
                    if (letterSpacingValue) {
                        letterSpacingValue.textContent = window.readerState.letterSpacing + 'px';
                    }
                }
                
                // Set up line height slider
                var lineHeightSlider = document.getElementById('line-height');
                var lineHeightValue = document.getElementById('line-height-value');
                
                if (lineHeightSlider) {
                    lineHeightSlider.addEventListener('input', function() {
                        window.readerState.lineHeight = parseInt(this.value);
                        updateLineHeightDisplay();
                        applyReaderStyles();
                    });
                }
                
                function updateLineHeightDisplay() {
                    if (lineHeightValue) {
                        lineHeightValue.textContent = (window.readerState.lineHeight / 100).toFixed(1);
                    }
                }
                
                // Apply reader styles
                function applyReaderStyles() {
                    var readerContainer = document.getElementById('reader-container');
                    if (!readerContainer) return;
                    
                    // Apply theme
                    switch (window.readerState.theme) {
                        case 'light':
                            readerContainer.style.backgroundColor = '#fff';
                            readerContainer.style.color = '#333';
                            break;
                        case 'sepia':
                            readerContainer.style.backgroundColor = '#f8f1e3';
                            readerContainer.style.color = '#5b4636';
                            break;
                        case 'dark':
                            readerContainer.style.backgroundColor = '#222';
                            readerContainer.style.color = '#ddd';
                            break;
                    }
                    
                    // Apply font styles
                    readerContainer.style.fontSize = window.readerState.fontSize + '%';
                    
                    // Apply font family
                    switch (window.readerState.fontFamily) {
                        case 'serif':
                            readerContainer.style.fontFamily = 'Georgia, Times, serif';
                            break;
                        case 'sans-serif':
                            readerContainer.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                            break;
                        case 'merriweather':
                            readerContainer.style.fontFamily = 'Merriweather, Georgia, serif';
                            break;
                        case 'open-dyslexic':
                            readerContainer.style.fontFamily = 'OpenDyslexic, sans-serif';
                            break;
                        case 'literata':
                            readerContainer.style.fontFamily = 'Literata, Georgia, serif';
                            break;
                    }
                    
                    // Apply letter spacing and line height
                    readerContainer.style.letterSpacing = window.readerState.letterSpacing + 'px';
                    readerContainer.style.lineHeight = (window.readerState.lineHeight / 100).toFixed(1);
                }
                
                // Initialize display
                updatePageDisplay();
                updateFontSizeDisplay();
                updateLetterSpacingDisplay();
                updateLineHeightDisplay();
                
                // If we have the full reader module, try to use it
                if (window.Reader && typeof window.Reader.openBook === 'function') {
                    try {
                        window.Reader.openBook(selectedBook);
                    } catch(e) {
                        console.error("Error opening book with Reader module:", e);
                        // We're already showing the fallback reader, so no need to do anything else
                    }
                } else {
                    console.log("Full Reader module not available, using basic reader mode");
                }
            } catch(e) {
                console.error("Error opening book:", e);
                alert("Error opening book: " + e.message);
            }
        }
        
        // Function to create pages from book content
        function createPagesFromBook(book) {
            var pages = [];
            
            // Title page
            pages.push('<div class="book-page">' +
                       '<h2>' + (book.title || 'Untitled Book') + '</h2>' +
                       '<p>Format: ' + (book.format || 'Unknown') + '</p>' +
                       (book.format === 'PDF' ? '<p>PDF files are displayed in simple text mode. Some formatting may be lost.</p>' : '') +
                       '</div>');
            
            // Check if we have extracted content
            if (book.extractedContent && book.extractedContent.length > 0) {
                // Split content into pages (roughly)
                var contentPerPage = 3; // Number of paragraphs per page
                var content = book.extractedContent;
                
                for (var i = 0; i < content.length; i += contentPerPage) {
                    var pageContent = '<div class="book-page">';
                    
                    // Add content for this page
                    for (var j = i; j < i + contentPerPage && j < content.length; j++) {
                        if (j === i && content[j].length < 50 && i < 5) {
                            // Short text at the beginning, might be a heading
                            pageContent += '<h3>' + content[j] + '</h3>';
                        } else {
                            pageContent += '<p>' + content[j] + '</p>';
                        }
                    }
                    
                    pageContent += '</div>';
                    pages.push(pageContent);
                }
            } else if (book.preview) {
                // If we have a preview but no structured content
                var text = book.preview;
                
                if (book.format === 'PDF') {
                    // For PDFs, show a special preview message
                    pages.push('<div class="book-page">' + 
                              '<h3>PDF Preview</h3>' +
                              '<p>This is a PDF file. Basic text extraction has been attempted, but full PDF rendering requires specialized software.</p>' +
                              '<p>PDF Title: ' + book.title + '</p>' +
                              '<p>Pages: Approximately ' + (book.pageCount || 'Unknown') + ' pages</p>' +
                              '</div>');
                              
                    // Add some generic PDF pages
                    pages.push('<div class="book-page">' +
                              '<h3>PDF Content</h3>' +
                              '<p>PDF files contain formatted text, images, and other elements that are not easily extracted in a web browser.</p>' +
                              '<p>This basic reader provides a simplified view of your document.</p>' +
                              '</div>');
                              
                    // Additional helpful information
                    pages.push('<div class="book-page">' +
                             '<h3>Reading PDFs</h3>' +
                             '<p>You can navigate through the available pages using the Previous and Next buttons below.</p>' +
                             '<p>For a full PDF reading experience with all formatting and images, you may need to use a dedicated PDF reader application.</p>' +
                             '</div>');
                } else {
                    // For other formats, split the preview into pages
                    var previewLength = 800; // Characters per page
                    for (var k = 0; k < text.length; k += previewLength) {
                        var chunk = text.substring(k, k + previewLength);
                        pages.push('<div class="book-page"><p>' + chunk.replace(/\n/g, '<br>') + '</p></div>');
                    }
                }
            }
            
            // If we have no content, add special message for the format
            if (pages.length <= 1) {
                if (book.format === 'PDF') {
                    pages.push('<div class="book-page">' +
                             '<h3>PDF Content</h3>' +
                             '<p>No text content could be extracted from this PDF file.</p>' +
                             '<p>This might be because:</p>' +
                             '<ul>' +
                             '<li>The PDF contains only images or scanned text</li>' +
                             '<li>The PDF has security restrictions or DRM protection</li>' +
                             '<li>The PDF uses uncommon encoding methods</li>' +
                             '</ul>' +
                             '<p>You can still navigate through the pages of this document, but the actual content cannot be displayed.</p>' +
                             '</div>');
                } else {
                    pages.push('<div class="book-page"><p>No content could be extracted from this ' + book.format + ' file.</p>' +
                             '<p>This might be due to DRM protection or the file format.</p></div>');
                }
                
                // Add a few more sample pages
                
                // Add a few more sample pages
                pages.push('<div class="book-page"><p>This is a sample page of content.</p>' +
                          '<p>In a fully working reader, you would see the actual content of your book here.</p></div>');
                
                pages.push('<div class="book-page"><p>Use the Previous and Next buttons to navigate between pages.</p>' +
                          '<p>You can also use the settings button to adjust the display.</p></div>');
            }
            
            // Ensure we have at least the right number of pages if a page count was detected
            if (book.pageCount && book.pageCount > pages.length) {
                // Add placeholder pages to match the estimated count
                var missingPages = book.pageCount - pages.length;
                for (var m = 0; m < missingPages; m++) {
                    pages.push('<div class="book-page"><h3>Page ' + (pages.length + 1) + '</h3>' +
                               '<p>Additional content would appear here in the full document.</p></div>');
                }
            }
            
            return pages;
        }
        
        // Function to delete a book
        function deleteBook(bookId) {
            console.log("Deleting book:", bookId);
            
            try {
                // Confirm deletion
                if (!confirm("Are you sure you want to delete this book?")) {
                    return;
                }
                
                // Get the book data from localStorage
                var storedBooks = localStorage.getItem('rustyPages_books');
                if (!storedBooks) {
                    alert("Error: No books found in storage");
                    return;
                }
                
                var books = JSON.parse(storedBooks);
                var updatedBooks = [];
                
                // Filter out the book to delete
                for (var i = 0; i < books.length; i++) {
                    if (books[i].id !== bookId) {
                        updatedBooks.push(books[i]);
                    }
                }
                
                // Save back to localStorage
                localStorage.setItem('rustyPages_books', JSON.stringify(updatedBooks));
                
                // Reload the book list
                loadSavedBooks();
                
                console.log("Book deleted successfully");
            } catch(e) {
                console.error("Error deleting book:", e);
                alert("Error deleting book: " + e.message);
            }
        }
        
        // Basic emergency functionality
        document.addEventListener('DOMContentLoaded', function() {
            var importBtn = document.getElementById('import-btn');
            var emptyImportBtn = document.getElementById('empty-import-btn');
            var emergencyImportBtn = document.getElementById('emergency-import-btn');
            var fileInput = document.getElementById('file-input');
            var bookList = document.getElementById('book-list');
            var emptyLibrary = document.getElementById('empty-library');
            
            // Load books immediately - using the global function now
            loadSavedBooks();
            
            // Set up import functionality
            function setupImportButton(btn) {
                if (btn && fileInput) {
                    btn.addEventListener('click', function() {
                        fileInput.click();
                    });
                }
            }
            
            setupImportButton(importBtn);
            setupImportButton(emptyImportBtn);
            setupImportButton(emergencyImportBtn);
            
            // Basic file input handler - now calls the global showFallbackUI save method
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        console.log("Files selected:", e.target.files.length);
                        
                        // Process file upload directly
                        var files = e.target.files;
                        processMobileBookUpload(files);
                    }
                });
            }
            
            // Function for processing mobile book uploads
            function processMobileBookUpload(files) {
                console.log("Processing mobile upload for", files.length, "files");
                
                try {
                    if (!files || files.length === 0) {
                        console.error("No files to process");
                        return;
                    }
                    
                    // Test if localStorage is writable
                    try {
                        localStorage.setItem('test_storage', 'test');
                        localStorage.removeItem('test_storage');
                    } catch(storageErr) {
                        console.error("localStorage test failed:", storageErr);
                        alert("Storage error: Your browser may be in private browsing mode or has localStorage disabled.");
                        return;
                    }
                    
                    // Process files one by one with FileReader
                    var processedFiles = 0;
                    var savedFiles = [];
                    
                    function processNextFile(index) {
                        if (index >= files.length) {
                            // All files processed, save to localStorage
                            saveProcessedBooks(savedFiles);
                            return;
                        }
                        
                        var file = files[index];
                        var fileName = file.name;
                        var fileExt = fileName.split('.').pop().toLowerCase();
                        
                        // Create book object
                        var book = {
                            id: 'book_' + Date.now() + '_' + index,
                            title: fileName.replace(/\.[^/.]+$/, ""), // Remove extension
                            format: fileExt === 'pdf' ? 'PDF' : 'EPUB',
                            dateAdded: new Date().toISOString(),
                            fileName: fileName
                        };
                        
                        // Read file content
                        var reader = new FileReader();
                        
                        reader.onload = function(e) {
                            try {
                                // Store file content (first 1MB for preview)
                                var content = e.target.result;
                                if (typeof content === 'string') {
                                    // Store first 50KB only to prevent localStorage overflow
                                    var previewSize = 50 * 1024; // 50KB
                                    book.preview = content.substring(0, previewSize);
                                    
                                    // For text-based files (like EPUBs), try to extract some text content
                                    if (fileExt === 'epub') {
                                        extractEpubContent(content, book);
                                    } else if (fileExt === 'pdf') {
                                        book.pageCount = estimatePdfPages(content, book);
                                    }
                                } else {
                                    book.preview = "Binary content preview not available";
                                }
                                
                                // Add to batch
                                savedFiles.push(book);
                                processedFiles++;
                                
                                // Process next file
                                processNextFile(index + 1);
                            } catch (readErr) {
                                console.error("Error processing file content:", readErr);
                                
                                // Still add the book without content
                                savedFiles.push(book);
                                processedFiles++;
                                
                                // Continue with next file
                                processNextFile(index + 1);
                            }
                        };
                        
                        reader.onerror = function() {
                            console.error("FileReader error for file:", fileName);
                            
                            // Still add the book metadata without content
                            savedFiles.push(book);
                            processedFiles++;
                            
                            // Continue with next file
                            processNextFile(index + 1);
                        };
                        
                        // Read the file as text or binary based on type
                        if (fileExt === 'epub') {
                            // EPUB is a ZIP file with HTML/XML content
                            reader.readAsText(file);
                        } else if (fileExt === 'pdf') {
                            // PDF is binary, read a portion for basic info
                            var slicedFile = file.slice(0, 1024 * 1024); // First 1MB
                            reader.readAsBinaryString(slicedFile);
                        } else {
                            // Unknown format, just read as text
                            reader.readAsText(file);
                        }
                    }
                    
                    // Start processing the files
                    processNextFile(0);
                } catch(e) {
                    console.error("Error processing book upload:", e);
                    alert("Error processing upload: " + e.message);
                }
            }
            
            // Function to extract basic content from EPUB files
            function extractEpubContent(content, book) {
                try {
                    // Simple content extraction for EPUB (which is basically a ZIP with HTML/XML)
                    var textContent = [];
                    
                    // Look for content between tags that typically contain text
                    var contentMatches = content.match(/<p[^>]*>(.*?)<\/p>/gi);
                    var titleMatches = content.match(/<h\d[^>]*>(.*?)<\/h\d>/gi);
                    var bodyMatches = content.match(/<body[^>]*>(.*?)<\/body>/si);
                    
                    if (contentMatches && contentMatches.length > 0) {
                        // Take just a few paragraphs as sample
                        for (var i = 0; i < Math.min(contentMatches.length, 20); i++) {
                            var cleanText = contentMatches[i].replace(/<[^>]*>/g, '');
                            if (cleanText.trim()) {
                                textContent.push(cleanText);
                            }
                        }
                    }
                    
                    if (titleMatches && titleMatches.length > 0) {
                        // Extract some headings
                        for (var j = 0; j < Math.min(titleMatches.length, 5); j++) {
                            var cleanTitle = titleMatches[j].replace(/<[^>]*>/g, '');
                            if (cleanTitle.trim()) {
                                textContent.unshift(cleanTitle); // Add titles at the beginning
                            }
                        }
                    }
                    
                    // If we found some content, store it
                    if (textContent.length > 0) {
                        book.extractedContent = textContent;
                    }
                    
                    // Try to estimate number of pages based on content size
                    if (bodyMatches && bodyMatches[0]) {
                        var bodyContent = bodyMatches[0];
                        var wordCount = bodyContent.split(/\s+/).length;
                        book.pageCount = Math.max(5, Math.ceil(wordCount / 250)); // Roughly 250 words per page
                    } else {
                        book.pageCount = Math.max(5, Math.ceil(content.length / 2000)); // Rough estimate
                    }
                } catch (e) {
                    console.error("Error extracting EPUB content:", e);
                    // Still set a default page count
                    book.pageCount = 5;
                }
            }
            
            // Function to extract basic info from PDF files
            function estimatePdfPages(content, book) {
                // Very rough estimate - actual PDF parsing would require a JS library
                try {
                    // Store a preview of the PDF binary content
                    book.preview = "This is a PDF document. PDF content cannot be directly extracted without a specialized PDF reader.";
                    
                    // Create some sample content for the PDF
                    var extractedContent = [];
                    
                    // Add title and basic info as content
                    extractedContent.push(book.title);
                    extractedContent.push("This is a PDF document with filename: " + book.fileName);
                    
                    // Try to find some text content in the PDF
                    // Look for text objects in the PDF
                    var textMatches = content.match(/\(([^\)]+)\)\s*Tj/g);
                    var textArrayMatches = content.match(/\[([^\]]+)\]\s*TJ/g);
                    
                    if (textMatches && textMatches.length > 0) {
                        // Extract some text objects
                        for (var i = 0; i < Math.min(textMatches.length, 30); i++) {
                            var text = textMatches[i].replace(/\(([^\)]+)\)\s*Tj/, '$1');
                            // Clean up PDF encoding
                            text = text.replace(/\\(\d{3})/g, function(match, octal) {
                                return String.fromCharCode(parseInt(octal, 8));
                            });
                            if (text.trim() && text.length > 3) {
                                extractedContent.push(text);
                            }
                        }
                    }
                    
                    if (textArrayMatches && textArrayMatches.length > 0) {
                        // Extract some text array objects
                        for (var j = 0; j < Math.min(textArrayMatches.length, 30); j++) {
                            var textArray = textArrayMatches[j].replace(/\[([^\]]+)\]\s*TJ/, '$1');
                            // Clean up and take only the text parts
                            var cleanedText = textArray.replace(/[^(]*\(([^)]*)\)[^(]*/g, '$1 ');
                            if (cleanedText.trim() && cleanedText.length > 3) {
                                extractedContent.push(cleanedText);
                            }
                        }
                    }
                    
                    // Add page numbers if found
                    var pageLabels = content.match(/\/PageLabels/);
                    if (pageLabels) {
                        extractedContent.push("This PDF contains labeled pages.");
                    }
                    
                    // If we found some content, store it
                    if (extractedContent.length > 2) { // If we have more than just the title and filename
                        book.extractedContent = extractedContent;
                    }
                    
                    // Look for page count indicators
                    var pageCount = 5; // Default
                    
                    // Try different methods to find page count
                    var pagesMatches = content.match(/\/Pages/g);
                    if (pagesMatches) {
                        pageCount = Math.max(5, pagesMatches.length);
                    } else {
                        // Alternative: find "/Page" objects
                        var pageMatches = content.match(/\/Page\s/g);
                        if (pageMatches) {
                            pageCount = Math.max(5, pageMatches.length);
                        } else {
                            // Alternative: find "/Count" objects that often indicate page count
                            var countMatch = content.match(/\/Count\s+(\d+)/);
                            if (countMatch && countMatch[1]) {
                                pageCount = Math.max(5, parseInt(countMatch[1], 10));
                            } else {
                                // If we can't determine, estimate based on size
                                pageCount = Math.max(5, Math.ceil(content.length / 5000));
                            }
                        }
                    }
                    
                    book.pageCount = pageCount;
                    return pageCount;
                } catch (e) {
                    console.error("Error estimating PDF info:", e);
                    book.pageCount = 5; // Default to 5 pages
                    return 5;
                }
            }
            
            // Function to save processed books to localStorage
            function saveProcessedBooks(books) {
                if (books.length === 0) {
                    alert("No books were processed successfully.");
                    return;
                }
                
                try {
                    // Get existing books
                    var existingBooks = [];
                    try {
                        var storedBooks = localStorage.getItem('rustyPages_books');
                        if (storedBooks) {
                            existingBooks = JSON.parse(storedBooks);
                        }
                    } catch(e) {
                        console.error('Error loading existing books:', e);
                        existingBooks = [];
                    }
                    
                    // Ensure existingBooks is an array
                    if (!Array.isArray(existingBooks)) {
                        existingBooks = [];
                    }
                    
                    // Check for duplicates and only add new books
                    var newBooks = [];
                    var duplicates = 0;
                    
                    for (var i = 0; i < books.length; i++) {
                        var isDuplicate = false;
                        var newBook = books[i];
                        
                        // Check if this book already exists (by title and format)
                        for (var j = 0; j < existingBooks.length; j++) {
                            var existingBook = existingBooks[j];
                            if (existingBook.title === newBook.title && 
                                existingBook.format === newBook.format) {
                                isDuplicate = true;
                                duplicates++;
                                break;
                            }
                        }
                        
                        if (!isDuplicate) {
                            newBooks.push(newBook);
                        }
                    }
                    
                    // If all books were duplicates, let the user know
                    if (newBooks.length === 0) {
                        alert('All ' + books.length + ' books were already in your library.');
                        loadSavedBooks(); // Refresh the view
                        
                        // Reset the file input to allow selecting the same file again
                        var fileInput = document.getElementById('file-input');
                        if (fileInput) {
                            fileInput.value = '';
                        }
                        return;
                    }
                    
                    // Add only non-duplicate books
                    var totalBooks = existingBooks.concat(newBooks);
                    
                    // Save back to localStorage
                    var booksToStore = JSON.stringify(totalBooks);
                    console.log("Saving books to localStorage:", totalBooks.length, "total books");
                    localStorage.setItem('rustyPages_books', booksToStore);
                    
                    // Verify the books were saved
                    var verifyTest = localStorage.getItem('rustyPages_books');
                    if (!verifyTest) {
                        throw new Error("Failed to verify books were saved to localStorage");
                    }
                    
                    // Show message with duplicate count if any
                    if (duplicates > 0) {
                        alert('Added ' + newBooks.length + ' book(s) to your library. ' + 
                              duplicates + ' duplicate(s) were skipped.');
                    } else {
                        alert('Added ' + newBooks.length + ' book(s) to your library.');
                    }
                    
                    // Update the book list display immediately
                    loadSavedBooks();
                    
                    // Reset the file input to allow selecting the same file again
                    var fileInput = document.getElementById('file-input');
                    if (fileInput) {
                        fileInput.value = '';
                    }
                } catch(e) {
                    console.error("Error saving books:", e);
                    alert("Error saving books: " + e.message);
                }
            }
            
            // Hide loader after 5 seconds no matter what
            setTimeout(function() {
                var loader = document.getElementById('initial-loader');
                if (loader) {
                    loader.style.display = 'none';
                    
                    // Only show emergency UI if needed (no books found)
                    var booksLoaded = loadSavedBooks();
                    
                    if (!booksLoaded) {
                        // Show emergency UI if we have no books
                        var emergencyError = document.getElementById('emergency-load-error');
                        var emergencyImport = document.getElementById('emergency-import');
                        if (emergencyError) emergencyError.style.display = 'block';
                        if (emergencyImport) emergencyImport.style.display = 'block';
                        
                        // Hide any empty message
                        if (emptyLibrary) emptyLibrary.style.display = 'none';
                    }
                }
            }, 5000);
        });
    </script>

    <!-- Polyfills -->
    <script src="js/polyfills.js"></script>
    
    <!-- Load scripts in a way that works with iOS 9 -->
    <script>
        // Function to load scripts sequentially with error handling
        function loadScriptsSequentially(scripts, callback) {
            var index = 0;
            
            function loadNext() {
                if (index >= scripts.length) {
                    if (typeof callback === 'function') {
                        callback(null);
                    }
                    return;
                }
                
                var script = document.createElement('script');
                script.src = scripts[index];
                
                script.onload = function() {
                    console.log('Loaded script: ' + scripts[index]);
                    index++;
                    loadNext();
                };
                
                script.onerror = function(e) {
                    console.error('Error loading script: ' + scripts[index], e);
                    if (typeof callback === 'function') {
                        callback(new Error('Failed to load ' + scripts[index]));
                    }
                };
                
                document.body.appendChild(script);
            }
            
            loadNext();
        }
        
        // Script loading order
        var scripts = [
            'js/lib/jszip.min.js',
            'js/lib/epub.min.js',
            'js/lib/pdf.min.js',
            'js/storage.js',
            'js/library.js',
            'js/reader.js',
            'js/app.js'
        ];
        
        // Load all scripts
        loadScriptsSequentially(scripts, function(error) {
            if (error) {
                console.error('Script loading failed:', error);
                // If we're on iOS 9 Safari, use fallback mode
                if (document.documentElement.classList.contains('ios-9')) {
                    window.RustyPages.activateFallbackMode();
                }
                
                // Show emergency content
                var emergencyError = document.getElementById('emergency-load-error');
                var emergencyImport = document.getElementById('emergency-import');
                var loadingScreen = document.getElementById('initial-loader');
                
                if (loadingScreen) loadingScreen.style.display = 'none';
                if (emergencyError) emergencyError.style.display = 'block';
                if (emergencyImport) emergencyImport.style.display = 'block';
                
                // Hide any empty message
                var emptyMsg = document.getElementById('empty-library');
                if (emptyMsg) emptyMsg.style.display = 'none';
            } else {
                console.log('All scripts loaded successfully');
                
                // Configure PDF.js worker
                if (window.pdfjsLib) {
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'js/lib/pdf.worker.min.js';
                }
                
                // If app.js didn't initialize us after 3 seconds, try fallback
                setTimeout(function() {
                    if (!window.RustyPages.ready) {
                        console.warn('Application failed to initialize after timeout');
                        window.RustyPages.activateFallbackMode();
                        
                        // Also show emergency content as a last resort
                        var emergencyError = document.getElementById('emergency-load-error');
                        var emergencyImport = document.getElementById('emergency-import');
                        var loadingScreen = document.getElementById('initial-loader');
                        
                        if (loadingScreen) loadingScreen.style.display = 'none';
                        if (emergencyError) emergencyError.style.display = 'block';
                        if (emergencyImport) emergencyImport.style.display = 'block';
                        
                        // Hide any empty message
                        var emptyMsg = document.getElementById('empty-library');
                        if (emptyMsg) emptyMsg.style.display = 'none';
                    }
                }, 3000);
            }
        });
    </script>
</body>
</html> 